# Prompt 3-fix：修正 Reel 輪帶運動與符號顯示問題

## 問題 (Problem)

### 問題 1：符號錯位
- **現象**：stopped 狀態顯示的符號與 SpinPacket.board 錯位一格
- **狀態**：當 Reel 進入 `stopped` 狀態時，符號向下錯位一格
- **原因**：`translateY(-symbolHeight * 1)` 導致符號列表向上移動，使 index 0 的符號被移出可見區域，index 1 顯示在 row 0 的位置

### 問題 2：輪帶消失
- **現象**：stopping 階段某些情況下輪帶消失，變成空盤
- **狀態**：從 `spinning` 進入 `stopping` 階段時，符號列表消失
- **原因**：`baseTranslate` 計算基於假符號數量（30），但最終符號列表數量不同（3 × 15 = 45），導致符號列表移出可見區域

### 問題 3：符號完全消失（問題 2 的延伸）
- **現象**：stopped 狀態時，所有符號消失，僅出現得分線
- **狀態**：當狀態直接變為 `stopped`（例如使用 `skip()`）時
- **原因**：`baseTranslate` 使用假符號的 `totalCycleHeight` 計算，但最終符號列表長度不同，導致符號列表完全移出可見區域

## 範圍 (Scope)

- **修改檔案**：`src/runtime/Reel.tsx`
- **禁區**：
  - 不可修改 Props 介面
  - 不可修改狀態機邏輯（idle/spinning/stopping/stopped 的轉換）
  - 不可修改其他檔案

## 修正內容 (Fix Details)

### 問題根源

#### 問題 1 根源
```typescript
// 原本（約第 228 行）
: state === 'stopped'
? `translateY(-${symbolHeight * 1}px)`  // ❌ 錯誤
```

**錯誤原因**：
- `translateY(-symbolHeight * 1)` 會讓符號列表向上移動一個符號高度
- 導致 index 0 的符號被移出可見區域
- index 1 顯示在 row 0，index 2 顯示在 row 1，造成向下錯位一格

#### 問題 2 與 3 根源
```typescript
// 原本（約第 68-73 行）
const iconsCount = 30; // 單個週期圖示數
const totalCycleHeight = symbolHeight * iconsCount;
const copies = 15;
const baseTranslate = -(totalCycleHeight * Math.floor(copies / 2));
```

**錯誤原因**：
- `baseTranslate` 基於假符號數量（30）計算
- 但最終符號列表只有 3 個符號，複製 15 份 = 45 個符號
- 當 `showFinalSymbols = true` 時，仍使用假符號的 `baseTranslate`
- 計算結果：`baseTranslate = -210 * symbolHeight`，但符號列表總高度只有 `45 * symbolHeight`
- 導致符號列表完全移出可見區域

### 修正方案

#### 修正 1：stopped 狀態的 transform
**邏輯說明**：
- stopped 狀態時，符號列表應該對齊到第一個符號（index 0）顯示在 row 0
- 因此 transform 應該是 `translateY(0)`，而不是 `translateY(-symbolHeight * 1)`

#### 修正 2：分別計算 baseTranslate
**邏輯說明**：
- 假符號列表：30 個符號 × 15 份 = 450 個符號
- 最終符號列表：3 個符號 × 15 份 = 45 個符號
- 需要分別計算兩個 `baseTranslate`：
  - `dummyBaseTranslate`：基於假符號的 cycleHeight
  - `finalBaseTranslate`：基於最終符號的 cycleHeight
- 根據 `showFinalSymbols` 狀態動態選擇對應的 `baseTranslate`

**計算公式**：
```typescript
const dummyCycleHeight = symbolHeight * 30;
const finalCycleHeight = symbolHeight * 3;
const dummyBaseTranslate = -(dummyCycleHeight * Math.floor(15 / 2));
const finalBaseTranslate = -(finalCycleHeight * Math.floor(15 / 2));
const baseTranslate = showFinalSymbols ? finalBaseTranslate : dummyBaseTranslate;
```

### 完整修正

#### 修正 1：stopped 狀態的 transform（約第 237 行）

**原本**：
```typescript
: state === 'stopped'
? `translateY(-${symbolHeight * 1}px)`
```

**修正為**：
```typescript
: state === 'stopped'
? `translateY(0px)`  // ✅ 對齊第一個符號
```

#### 修正 2：stopped useEffect 中的 offset 設定（約第 200 行）

**原本**：
```typescript
if (state === 'stopped') {
  setOffset(symbolHeight * 1);
}
```

**修正為**：
```typescript
if (state === 'stopped') {
  setOffset(0);  // ✅ 對齊第一個符號
}
```

#### 修正 3：highlightedRows 計算邏輯（約第 255-262 行）

**原本**：
```typescript
if (state === 'stopped') {
  if (index >= 1) {
    const relativeIndex = (index - 1) % 3;
    // ...
  }
}
```

**修正為**：
```typescript
if (state === 'stopped' && showFinalSymbols) {
  // offset = 0 時，可見區域從 middleStart 開始
  const visibleIndex = index - middleStart;
  if (visibleIndex >= 0 && visibleIndex < 3) {
    isHighlighted = highlightedRows.includes(visibleIndex);
  }
}
```

#### 修正 4：分別計算 baseTranslate（約第 69-82 行）

**原本**：
```typescript
const symbolHeight = symbolSize * symbolScale;
const iconsCount = 30; // 單個週期圖示數
const totalCycleHeight = symbolHeight * iconsCount;
const copies = 15;
const baseTranslate = -(totalCycleHeight * Math.floor(copies / 2));
```

**修正為**：
```typescript
const symbolHeight = symbolSize * symbolScale;
const dummyIconsCount = 30; // 假符號單個週期圖示數
const finalIconsCount = symbols.length; // 最終符號數量（3）
const copies = 15; // 副本數量

// 分別計算假符號和最終符號的循環高度和基準偏移
const dummyCycleHeight = symbolHeight * dummyIconsCount;
const finalCycleHeight = symbolHeight * finalIconsCount;
const dummyBaseTranslate = -(dummyCycleHeight * Math.floor(copies / 2));
const finalBaseTranslate = -(finalCycleHeight * Math.floor(copies / 2));

// 根據當前顯示的符號列表選擇對應的 baseTranslate
const baseTranslate = showFinalSymbols ? finalBaseTranslate : dummyBaseTranslate;
```

#### 修正 5：stopping 階段的動畫計算（約第 94、119 行）

**修正**：確保使用假符號的 cycleHeight 進行計算

```typescript
// startSpin 中使用假符號的 cycleHeight
const newOffset = (elapsed * speed) % dummyCycleHeight;

// handleStopTrigger 中使用假符號的 cycleHeight
const minDistance = dummyCycleHeight * 2;
```

#### 修正 6：stopping 結束時的處理（約第 148-160 行）

**修正**：確保 transition 結束後切換到最終符號並重置 offset

```typescript
const handleTransitionEnd = useCallback(() => {
  if (!isStopping) return;
  
  setIsStopping(false);
  setTransitionStyle('none');
  setShowFinalSymbols(true);  // ✅ 切換到最終符號
  setOffset(0);  // ✅ 重置 offset
  currentOffsetRef.current = 0;
  
  if (onStopped) {
    onStopped();
  }
}, [isStopping, onStopped]);
```

#### 修正 7：state 變化時的處理（約第 163-214 行）

**修正**：確保各狀態轉換時正確設定 `showFinalSymbols` 和 `offset`

```typescript
useEffect(() => {
  const prevState = prevStateRef.current;
  prevStateRef.current = state;

  if (state === 'spinning' && prevState !== 'spinning') {
    // 進入 spinning 狀態
    setShowFinalSymbols(false);  // ✅ 使用假符號
    setOffset(0);
    // ...
  } else if (state === 'stopped') {
    // 進入 stopped 狀態
    setShowFinalSymbols(true);  // ✅ 使用最終符號
    setOffset(0);  // ✅ 重置 offset
    // ...
  } else if (state === 'idle') {
    // 進入 idle 狀態
    setShowFinalSymbols(true);  // ✅ 使用最終符號
    setOffset(0);  // ✅ 重置 offset
    // ...
  }
}, [state, startSpin, handleStopTrigger]);
```

### 關聯修正/副程式

#### 1. `startSpin` 函式（約第 85-102 行）
- 使用 `dummyCycleHeight` 進行 offset 計算
- 確保 spinning 階段使用假符號列表

#### 2. `handleStopTrigger` 函式（約第 105-145 行）
- 使用 `dummyCycleHeight` 計算最小滾動距離
- 確保減速動畫使用正確的 cycleHeight

#### 3. `middleStart` 計算（約第 225-226 行）
- 根據當前顯示的符號列表動態計算
- 確保高亮邏輯正確對齊

```typescript
const currentIconsCount = showFinalSymbols ? finalIconsCount : dummyIconsCount;
const middleStart = Math.floor(copies / 2) * currentIconsCount;
```

## 驗收條件 (Acceptance Criteria)

1. **符號對齊**：stopped 狀態顯示的符號與 SpinPacket.board 完全一致
   - 例如：`board.reels[0] = ["L3", "H2", "L1"]`
   - 顯示順序：row 0 = L3, row 1 = H2, row 2 = L1

2. **動畫流暢**：spinning → stopping → stopped 無跳躍或消失
   - 輪帶向下旋轉（符號從上方進入視野）
   - stopping 階段符號列表不消失
   - stopped 狀態符號正確顯示

3. **中獎線高亮**：正確的符號被高亮
   - 根據 `highlightedRows` 正確高亮對應的 row（0, 1, 2）

4. **無 any 型別**：所有型別都有明確定義

5. **TypeScript 編譯檢查**：`npx tsc --noEmit` 無錯誤

6. **Linter 檢查**：無 linter 錯誤

## 輸出格式 (Output Format)

請提供完整的 `src/runtime/Reel.tsx` 檔案內容，並在關鍵修正位置標註註解說明。

---

## 修正摘要

### 主要修正點

1. **符號錯位修正**：
   - stopped 狀態 transform 從 `translateY(-symbolHeight * 1)` 改為 `translateY(0)`
   - stopped 狀態 offset 從 `symbolHeight * 1` 改為 `0`

2. **輪帶消失修正**：
   - 分別計算 `dummyBaseTranslate` 和 `finalBaseTranslate`
   - 根據 `showFinalSymbols` 動態選擇對應的 `baseTranslate`
   - 確保 spinning 階段使用假符號的 baseTranslate
   - 確保 stopped 階段使用最終符號的 baseTranslate

3. **高亮邏輯修正**：
   - 使用動態 `currentIconsCount` 計算 `middleStart`
   - 確保高亮邏輯正確對齊到可見區域

### 關鍵變更

- 新增 `showFinalSymbols` 狀態，用於控制顯示假符號或最終符號
- 分別計算 `dummyCycleHeight` 和 `finalCycleHeight`
- 分別計算 `dummyBaseTranslate` 和 `finalBaseTranslate`
- 所有 offset 計算在 stopped 狀態時重置為 0
- 所有 transform 在 stopped 狀態時使用 `translateY(0)`

