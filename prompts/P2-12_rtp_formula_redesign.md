# P2-12 RTP 公式重新設計

## 問題背景

### 發現過程

在執行 P2-11（Free Spin 預期價值計算）時，驗證發現「理論 RTP」與「實際 RTP」存在巨大差異。

### 測試案例

| 設定 | 值 |
|------|-----|
| 符號 | 1 個符號，3 連線 = 8x |
| Outcome | 1x~8x, weight = 100 |

| 指標 | 公式結果 | 實際結果 |
|------|---------|---------|
| 理論 RTP | `(1+8)/2 × 100% = 450%` | - |
| 實際 RTP | - | `800%` |

**差異原因**：Outcome 範圍內唯一可達成的分數是 8x，所以每局都得 8x。

---

## 根本問題

### 當前公式

```typescript
// rtp-calculator.ts
NG_RTP = Σ (P_outcome × AvgMultiplier_outcome) × 100%

// 其中
P_outcome = weight / Σweights
AvgMultiplier = (min + max) / 2
```

### 錯誤假設

**公式假設**：分數在 Outcome 區間內是「均勻分布」的

**實際情況**：分數分布是由符號配置的「離散賠付組合」決定的

> **Outcome 不能創造分數，只能篩選分數。**

---

## 影響 RTP 的實際因素（P2-13 決策後）

> [!IMPORTANT]
> 根據 P2-13 決策，符號權重（ngWeight/fgWeight）將僅影響視覺動畫，不影響數學層。
> Pool 生成改為**均勻分布**，RTP 由 Outcome 權重直接決定。

```
真實 RTP = f(Outcome 權重, 符號賠付表, 線路配置, 盤面尺寸, Wild 設定)
```

| 因素 | 說明 | 對 RTP 的影響 |
|------|------|-------------|
| **Outcome 權重** | 各 Outcome 的抽取機率 | **直接決定 RTP** |
| 符號賠付表 | 各符號 3/4/5 連線分數 | 決定可能的離散分數點 |
| ~~符號權重~~ | ~~ngWeight / fgWeight~~ | ~~僅影響視覺動畫~~ |
| 符號數量 | 高分/低分符號比例 | 影響分數分布範圍 |
| 線路數量 | 10/20/25 條線等 | 影響總中獎次數 |
| 線路路徑 | 線的形狀 | 影響連線位置 |
| Wild 替代 | 是否可替代一般符號 | 增加連線機率 |
| 盤面尺寸 | 5x3 vs 5x4 | 影響 Scatter 觸發機率 |

---

## 用戶工作流程分析

```
符號設定 ──┬──> Pay Lines ──> Outcome ──> 理論 RTP ──> Simulation
(8成已決定)│                    │              │           │
           │                    │              ↓           ↓
           └────────────────────┴──────> 三角/四角微調 <────┘
```

### 關鍵洞察

| 階段 | 用戶行為 | 需要的資訊 |
|------|---------|-----------|
| 符號/線路設定 | 通常已有想法，直接輸入 | 暫無 RTP 需求 |
| Outcome 設定 | **核心調整點** | 希望快速看到 RTP 變化 |
| 確認理論值 | 判斷是否需要調整 | 需要**即時**反饋 |
| Simulation | 驗證最終結果 | 精確 RTP |
| 微調 | 迭代優化 | 快速 RTP 預覽 |

**核心需求**：用戶在調整 Outcome 時需要**即時看到 RTP 預覽**，而非等待 Build Pool 或跑完 Simulation。

---

## 解決方案建議：雙層 RTP 顯示

### 設計理念

不選擇單一方案，而是**混合 B + C**，在不同階段提供不同資訊：

```
┌─────────────────────────────────────────────────────────────┐
│                       RTP 面板                               │
├─────────────────────────────────────────────────────────────┤
│  📊 符號分數分布估算（即時）                                   │
│  ┌─────────────────────────────────────────┐                │
│  │ 預估平均分數: 4.2x ± 0.3                  │  ← 方案 C    │
│  │ 分數範圍: 0x ~ 25x                        │              │
│  └─────────────────────────────────────────┘                │
│                                                              │
│  🎯 目標 RTP（根據 Outcome 權重）                              │
│  ┌─────────────────────────────────────────┐                │
│  │ NG: 75.00%  |  FG: +23.50%  |  總: 98.50%│  ← 現有公式  │
│  └─────────────────────────────────────────┘                │
│                                                              │
│  ✅ 實際 RTP（Build Pool 後顯示）                             │
│  ┌─────────────────────────────────────────┐                │
│  │ NG: 78.32%  |  FG: +21.18%  |  總: 99.50%│  ← 方案 B    │
│  │ ⚠️ 與目標差異: +1.00%                      │              │
│  └─────────────────────────────────────────┘                │
└─────────────────────────────────────────────────────────────┘
```

### 三個指標的角色

| 指標 | 時機 | 數據來源 | 用途 |
|------|------|---------|------|
| **符號分數分布** | 符號設定完成後 | 蒙地卡羅抽樣 (1000 次) | 了解符號配置的分數範圍 |
| **目標 RTP** | Outcome 設定時即時更新 | 現有公式 (權重×平均倍率) | 快速預覽設計意圖 |
| **實際 RTP** | Build Pool 完成後 | Pool 內盤面的實際分數 | 精確驗證 |

### 新增功能：分數分布預覽

在「符號設定」面板增加即時分數估算：

```typescript
// 每當符號配置變更時自動執行
function estimateScoreDistribution(sampleSize = 1000): ScoreDistribution {
  const scores: number[] = [];
  for (let i = 0; i < sampleSize; i++) {
    const board = generateRandomBoard();
    scores.push(calculateBoardScore(board));
  }
  return {
    min: Math.min(...scores),
    max: Math.max(...scores),
    avg: scores.reduce((a, b) => a + b) / scores.length,
    stdDev: calculateStdDev(scores),
    histogram: buildHistogram(scores),
  };
}
```

### UI/UX 調整建議

#### 1. Symbol Settings 面板

增加「分數分布預覽」區塊：

```
┌─ 符號設定 ────────────────────────────────┐
│  [符號列表...]                             │
│                                           │
│  📊 分數分布預覽                           │
│  ├─ 平均: 4.2x (±0.3)                     │
│  ├─ 範圍: 0x ~ 25x                        │
│  └─ [查看直方圖]                          │
│                                           │
│  ⚠️ 提示: 分數集中在 0x 和 8x，建議調整...  │
└───────────────────────────────────────────┘
```

#### 2. Outcome 面板

增加「分數覆蓋預警」：

```
┌─ Outcome 設定 ───────────────────────────┐
│                                          │
│  小獎 | 1x~3x  | Weight: 40  | ⚠️ 無盤面  │
│  中獎 | 4x~8x  | Weight: 35  | ✅ 可建池  │
│  大獎 | 9x~15x | Weight: 20  | ✅ 可建池  │
│  巨獎 | 50x+   | Weight: 5   | ⚠️ 僅 2%   │
│                                          │
└──────────────────────────────────────────┘
```

- `⚠️ 無盤面`：符號分數分布中沒有落入此區間的分數
- `⚠️ 僅 2%`：符號分數中只有 2% 落入此區間

#### 3. RTP 面板改版

```
┌─ RTP 分析 ────────────────────────────────┐
│                                           │
│  目標 RTP (Outcome 權重)     │    75.00%  │
│  ───────────────────────────────────────  │
│  實際 RTP (Build Pool 後)    │    78.32%  │  ← 建池後才顯示
│  ───────────────────────────────────────  │
│  差異                        │    +3.32%  │
│                                           │
│  💡 差異原因: 「小獎(1x~3x)」區間的實際    │
│     平均分數為 2.8x，高於 2.0x 的中點      │
└───────────────────────────────────────────┘
```

---

## 實作優先級

### Phase 1：分數分布估算（優先）

1. 新增 `estimateScoreDistribution()` 函式
2. 在 Symbol Settings 面板顯示分數分布
3. 在 Outcome 面板顯示「分數覆蓋預警」

### Phase 2：實際 RTP 計算

1. 在 Build Pool 完成後計算實際 RTP
2. 顯示與目標 RTP 的差異
3. 提供差異原因分析

### Phase 3：FS 預期價值整合

1. 重新評估 P2-11 的 FS 計算邏輯
2. 將 FS 貢獻納入分數分布估算
3. 區分 NG / FG 的分數分布

---

## P2-11 處置

P2-11（Free Spin 預期價值計算）基於錯誤的理論 RTP 公式，其修改已被回滾。

**回滾內容**：
- `src/engine/pool-builder.ts` 還原至 `5d6aa29` commit 狀態

**P2-11 的核心思路（將 FS 預期價值納入盤面分數）在 Phase 3 重新評估。**

---

## 執行計畫（已決策）

> [!NOTE]
> 已於 2026-01-14 決議採用**選項 A**（保留權重欄位但標註為視覺用）

### 執行順序

1. **P2-13**：符號權重分離（視覺層 vs 數學層）← 必須先執行
2. **P2-12 Phase 1**：分數分布估算 + Outcome 預警
3. **P2-12 Phase 2**：實際 RTP 計算 + 差異分析
4. **P2-11 重啟**：FS 預期價值整合（待 P2-13 完成後重新評估）

---

## 相關 Issue

- **P2-13 符號權重分離（前置條件）**
- P2-11 Scatter 價值計算（已回滾，待 P2-13 後重啟）
- P2-10 Free Spin 控制整合（已完成）

## 參考資料

- [rtp-calculator.ts](file:///d:/Projects/slot-ide/src/engine/rtp-calculator.ts)
- [pool-builder.ts](file:///d:/Projects/slot-ide/src/engine/pool-builder.ts)
